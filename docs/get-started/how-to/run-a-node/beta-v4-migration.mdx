---
title: Beta v4 migration guide
description: Details of how to migrate your nodes following Beta v4 upgrade
image: /img/socialCards/beta-v4-migration-guide.jpg
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

Linea Beta v4 is a **mandatory hard fork** introducing **Maru**, the new
consensus layer (CL).

Maru replaces Clique and aligns Linea with Ethereum's dual-layer design
(execution and consensus).

After the fork:

- You must run **both** an execution layer (EL) client and Maru, a CL client
- Sequencer signatures move from EL `extraData` to the **Maru attestations
  API**.
- EL clients must be upgraded to Beta v4 compatible versions (any EL client that
  supports Prague should be compatible).

See the [Beta v4 release notes](../../../release-notes.mdx#beta-v4) for the
scheduled hard fork dates.

## Breaking change: sequencer signatures

**Sequencer signatures will no longer be in EL block `extraData` after the
upgrade.**

Before (pre-fork):

```
// on EL client
let signatures = block.extra_data;
```

After (post-fork):

```
// Must switch to Maru API
let signatures = maru_api.get("/eth/v2/beacon/blocks/{block_id}").data.message.body.attestations;
```

`attestations` returns a list containing the current block signature/attestation
and the previous block signature/attestation.

## Key architecture changes

### Current

- Single layer: EL client only (Besu with Clique)
- Sequencer signatures: Stored in EL block `extraData`
- Block production: Clique handles execution and consensus

### After Beta v4

- Dual-layer architecture: Execution Layer (EL) client + Consensus Layer (CL)
  client (The CL is currently powered by Maru, a consensus client implementing a
  customized variation of the QBFT algorithm. While Maru is the only supported
  client today, the architecture is designed to support future client diversity
  and algorithm evolution).
- Sequencer signatures: Moved to Maru's `SealedBeaconBlock.commitSeals`
- Block production: Maru (QBFT) coordinates consensus, EL executes transactions
- API: Signatures and consensus data available via Maru APIs

## EL client compatibility

By design, Linea with Maru will support any client compatible with L1. So any
vanilla client compatible with Prague will work.

Supported EL clients (from
[e2e tests](https://github.com/Consensys/maru/tree/main/e2e)):

- Besu: [25.8.0](https://github.com/hyperledger/besu/releases/tag/25.8.0) or
  higher
- Geth: Use the latest release (downtime required)
- Erigon: Use the latest release
- Nethermind: Use the latest release
- Linea-specific: A new `linea-besu-package` release is available via Docker: `consensys/linea-besu-package:beta-v4.0-rc11-20251004063519-a5c4c31`

**⚠️ Geth-specific issue:**

- Geth v1.15+ → incompatible with Clique (pre-fork)
- Geth v1.13 → incompatible with Prague (post-fork)
- Result: No zero-downtime upgrade path; must plan maintenance window.

## Upgrade strategy

Depending on your EL client, follow the relevant upgrade path:

### Besu, Erigon, Nethermind (zero-downtime)

**Pre-upgrade**

- Prepare Docker setup (EL + Maru)
- Upgrade EL client to Prague-compatible version

**During upgrade**

- Start Maru before the fork timestamp
- Keep EL client running
- Monitor logs for sync and consensus:
  - `docker logs linea-maru | grep "imported block"`
  - `curl -s -X POST http://localhost:8545 -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'`

**Post-upgrade**

- Verify block import in Maru logs
- Confirm EL block height with `eth_blockNumber`

### ⚠️ Geth (downtime required):

**Pre-upgrade**

- Prepare Docker setup (EL + Maru)
- Plan a short maintenance window after the fork
- **Note: the genesis file provided for Besu should be used for Geth as well.**

**During upgrade**

- Stop Geth after fork timestamp
- Upgrade to Geth v1.15+ (Prague-compatible)
- Start both Maru and Geth together

**Post-upgrade**

- Same verification steps as above

## Installation and setup guide

### Prerequisites

- Docker and Docker Compose
  ([https://hub.docker.com/r/consensys/maru/tags](https://hub.docker.com/r/consensys/maru/tags)
  or https://github.com/Consensys/maru)
- At least 8GB RAM (16GB recommended)
- Open ports: 8545, 8550, 8080, 9090, 9000
- Synced EL client (for example Besu)
- L1 RPC URL — required for Maru to track zk-proof verification and determine which L2 blocks are 
  finalized

### Step 1: Directory structure

Decide on and create a directory where you want to run your clients. For example:

```bash
mkdir -p ~/linea-node/besu/config
cd ~/linea-node
```

You may also swap out `besu/config` for `maru/config`, or depending on which client you're using.

### Step 2: Besu configuration

Retrieve the `config.toml` from the appropriate network's directory:

{/* TODO: check links are correct before merging — added before they were confirmed */}
<Tabs groupId="networks" className="my-tabs">
  <TabItem value="mainnet" label="Mainnet">
    - [Genesis file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-mainnet/besu-genesis.json)
    - [Config file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-mainnet/linea-besu.config.toml)
  </TabItem>
  <TabItem value="sepolia" label="Sepolia">
    - [Linea Sepolia](https://github.com/Consensys/linea-monorepo/tree/main/docker/linea-sepolia/besu-genesis.json)
    - [Config file](https://github.com/Consensys/linea-monorepo/tree/main/docker/linea-sepolia/linea-besu.config.toml)
  </TabItem>
</Tabs>

### Step 3: Maru configuration (follower node)

Retrieve the `maru-config.toml` and `maru-genesis.json` from the appropriate network's directory:
{/* CHECK MAINNET LINKS */}
<Tabs groupId="networks" className="my-tabs">
  <TabItem value="mainnet" label="Mainnet">
    - [Genesis file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-mainnet/maru-genesis.json)
    - [Config file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-mainnet/maru-config.toml)
  </TabItem>
  <TabItem value="sepolia" label="Sepolia">
    - [Genesis file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-sepolia/maru/config/maru-genesis.json)
    - [Config file](https://github.com/Consensys/linea-monorepo/tree/main/docker/linea-sepolia/maru/config/maru-config.toml)
  </TabItem>
</Tabs>

### Step 4: Run `docker-compose`

Ensure you have the `docker-compose.yml` file from the appropriate directory in the `linea-monorepo`: 

<Tabs groupId="networks" className="my-tabs">
  <TabItem value="mainnet" label="Mainnet">
    - [Docker compose file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-mainnet/docker-compose.yml)
  </TabItem>
  <TabItem value="sepolia" label="Sepolia">
    - [Docker compose file](https://github.com/Consensys/linea-monorepo/blob/main/docker/linea-sepolia/docker-compose.yml)
  </TabItem>
</Tabs>

### Step 7: Launch and verify

In the root directory you created in step 1, run:

```bash
# Start both services
docker-compose up maru-node besu-node
```

You can also manually check if Besu is syncing:

```bash
curl -X POST http://localhost:8545 -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```

Or check Maru's health:

```bash
curl -X GET "http://localhost:8080/eth/v1/node/health"
```

...and verify P2P connection:

```bash
docker logs linea-maru | grep "Currently connected peers"
# Should show: peers=[16Uiu2HAmR33t8RZiAHovuH9iH2UuUrajrbfyYowiYDAQo3D5Y9wg]
```

## JWT Authentication

For production environments, you should enable JWT authentication:

### Generate JWT secret

```bash
openssl rand -hex 32 > ~/linea-node/jwt/jwt.hex
```

### Update Besu config

```toml
# Replace engine-jwt-disabled=true with:
engine-jwt-enabled=true
engine-jwt-file="/opt/besu/jwt.hex"
```

### Update Maru config

```toml
[payload-validator]
engine-api-endpoint = { endpoint = "http://linea-besu:8550", jwt-secret-path = "/jwt.hex" }
```

### Update Docker volumes

```yaml
# Add to both Besu and Maru:
volumes:
  - ./jwt/jwt.hex:/jwt.hex:ro
```

## Private key management

**Development**: Maru auto-generates private keys at startup if none exist.
(TBC)

**Production**: Generate and backup your private key (not mandatory):

```bash
# Option 1: Let Maru auto-generate, then backup:
docker cp linea-maru:/data/private-key ./backup/

# Option 2: Generate using Maru's key generation tool:
# https://github.com/Consensys/maru/tree/main/jvm-libs/utils
```

:::info[Important]

Maintaining the same private key preserves node identity across restarts.

:::

## Troubleshooting

### Debug commands

```bash
# EL client block height
curl -s -X POST http://localhost:8545 -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'

# Maru health
curl http://localhost:8080/eth/v1/node/health

# Check block headers
curl http://localhost:8080/eth/v1/beacon/headers/head
```
